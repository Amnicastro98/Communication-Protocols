# I2C Basics Quick Reference

## Table of Contents
- [Introduction](#introduction)
- [I2C Signals](#i2c-signals)
- [Addressing](#addressing)
- [Basic Communication](#basic-communication)
- [Example Code](#example-code)

## Introduction
I2C (Inter-Integrated Circuit) is a synchronous serial communication protocol used for short-distance communication between microcontrollers and peripheral devices. It uses only two wires and supports multiple masters and slaves on the same bus. I2C is commonly used in embedded systems for connecting sensors, EEPROMs, displays, and other low-speed peripherals.

Key characteristics:
- Master-slave architecture (multi-master capable)
- Synchronous (uses clock signal)
- Half-duplex communication
- Addressing system for device selection
- Pull-up resistors required on both lines
- Lower speed compared to SPI but uses fewer pins

## I2C Signals
I2C uses two main signals:
- **SDA (Serial Data)**: Bidirectional data line
- **SCL (Serial Clock)**: Clock signal generated by master

Both lines are open-drain and require pull-up resistors (typically 4.7kÎ©).

```
Master/Slave --SDA--+-- Pull-up -- VCC
                    |
Master/Slave --SCL--+-- Pull-up -- VCC
```

## Addressing
I2C uses 7-bit or 10-bit addressing:
- **7-bit addressing**: 128 possible addresses (0x00-0x7F)
- **10-bit addressing**: 1024 possible addresses

Addresses are sent as the first byte after START condition. The least significant bit indicates read (1) or write (0) operation.

Reserved addresses:
- 0x00: General call address
- 0x01-0x07: CBUS addresses
- 0x78-0x7B: 10-bit slave addressing

## Basic Communication
I2C communication consists of:
1. **START condition**: SDA goes low while SCL is high
2. **Address frame**: 7-bit address + R/W bit
3. **ACK/NACK**: Acknowledgment from receiver
4. **Data frames**: 8-bit data + ACK/NACK
5. **STOP condition**: SDA goes high while SCL is high

```
START -> Address -> ACK -> Data -> ACK -> ... -> Data -> NACK -> STOP
```

## Example Code
```c
#include <avr/io.h>  // AVR microcontroller header
#include <util/delay.h>

// I2C Pins (for AVR ATMega328P)
#define SDA PC4
#define SCL PC5

// I2C Status codes
#define TW_START 0x08
#define TW_REP_START 0x10
#define TW_MT_SLA_ACK 0x18
#define TW_MT_DATA_ACK 0x28
#define TW_MR_SLA_ACK 0x40
#define TW_MR_DATA_ACK 0x50
#define TW_MR_DATA_NACK 0x58

// Initialize I2C as Master
void I2C_MasterInit(uint32_t freq) {
    // Set prescaler to 1
    TWSR = 0x00;
    // Set bit rate (assuming 16MHz clock)
    TWBR = ((F_CPU / freq) - 16) / 2;
    // Enable TWI
    TWCR = (1 << TWEN);
}

// Send START condition
void I2C_Start(void) {
    TWCR = (1 << TWINT) | (1 << TWSTA) | (1 << TWEN);
    while (!(TWCR & (1 << TWINT)));
}

// Send STOP condition
void I2C_Stop(void) {
    TWCR = (1 << TWINT) | (1 << TWSTO) | (1 << TWEN);
}

// Write byte and return ACK status
uint8_t I2C_Write(uint8_t data) {
    TWDR = data;
    TWCR = (1 << TWINT) | (1 << TWEN);
    while (!(TWCR & (1 << TWINT)));
    return (TWSR & 0xF8);
}

// Read byte with ACK
uint8_t I2C_ReadACK(void) {
    TWCR = (1 << TWINT) | (1 << TWEN) | (1 << TWEA);
    while (!(TWCR & (1 << TWINT)));
    return TWDR;
}

// Read byte with NACK
uint8_t I2C_ReadNACK(void) {
    TWCR = (1 << TWINT) | (1 << TWEN);
    while (!(TWCR & (1 << TWINT)));
    return TWDR;
}

// Example usage: Write to EEPROM
void EEPROM_WriteByte(uint8_t dev_addr, uint16_t mem_addr, uint8_t data) {
    I2C_Start();
    I2C_Write(dev_addr << 1);  // Write address
    I2C_Write(mem_addr >> 8);  // High byte of memory address
    I2C_Write(mem_addr & 0xFF); // Low byte of memory address
    I2C_Write(data);           // Data byte
    I2C_Stop();
    _delay_ms(5);  // Write cycle time
}

// Example usage: Read from EEPROM
uint8_t EEPROM_ReadByte(uint8_t dev_addr, uint16_t mem_addr) {
    I2C_Start();
    I2C_Write(dev_addr << 1);  // Write address
    I2C_Write(mem_addr >> 8);  // High byte of memory address
    I2C_Write(mem_addr & 0xFF); // Low byte of memory address
    I2C_Start();               // Repeated start
    I2C_Write((dev_addr << 1) | 1); // Read address
    uint8_t data = I2C_ReadNACK();  // Read data with NACK
    I2C_Stop();
    return data;
}

int main(void) {
    I2C_MasterInit(100000);  // 100kHz
    
    // Example: Write 0xAA to EEPROM address 0x0000
    EEPROM_WriteByte(0x50, 0x0000, 0xAA);
    
    // Example: Read from EEPROM address 0x0000
    uint8_t read_data = EEPROM_ReadByte(0x50, 0x0000);
    
    while(1);
    return 0;
}
